{% extends "base.html" %}
{% block title %}CSR Dashboard{% endblock %}

{% block content %}
<div class="admin-container mt-5">
    <h1 class="mb-4">CSR Dashboard</h1>

    <!-- Search & Filter Bar -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <h4 class="fw-bold mb-0">All Requests</h4>

        <div class="d-flex align-items-center gap-2">
            <!-- Search Field -->
            <input type="text" 
                   class="form-control" 
                   placeholder="Search requests..." 
                   id="searchInput" 
                   style="max-width: 250px;">

            <!-- Status Filter -->
            <select class="form-select" id="statusFilter" style="max-width: 180px;">
                <option value="">All Status</option>
                <option value="Pending">Pending</option>
                <option value="Accepted">Accepted</option>
                <option value="Assigned">Assigned</option>
                <option value="Completed">Completed</option>
            </select>
        </div>
    </div>

    <!-- Table -->
    <div class="table-container position-relative">
        <table class="table align-middle borderless-table">
            <thead class="table-light sticky-top">
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>PIN Name</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Views</th>
                    <th style="width: 120px;">Actions</th>
                </tr>
            </thead>
            <tbody id="requestTableBody">
                {% if requests_with_users %}
                    {% for req, user in requests_with_users %}
                    <tr>
                        <td><strong>{{ req.id }}</strong></td>
                        <td>{{ req.title }}</td>
                        <td>{{ user.name if user else 'N/A' }}</td>
                        <td>{{ req.category or 'N/A' }}</td>
                        <td>
                            {% if req.status == 'Pending' %}
                                <span class="badge bg-warning text-dark">Pending</span>
                            {% elif req.status == 'Accepted' %}
                                <span class="badge bg-info">Accepted</span>
                            {% elif req.status == 'Assigned' %}
                                <span class="badge bg-primary">Assigned</span>
                            {% elif req.status == 'Completed' %}
                                <span class="badge bg-success">Completed</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ req.status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ req.view_count or 0 }}</td>
                        <td>
                            <!-- Actions Dropdown -->
                            <div class="dropdown position-static">
                                <button class="btn btn-outline-primary btn-sm dropdown-toggle" 
                                        type="button" 
                                        id="actionDropdown{{ req.id }}" 
                                        data-bs-toggle="dropdown" 
                                        aria-expanded="false">
                                    Actions
                                </button>
                                <ul class="dropdown-menu shadow" aria-labelledby="actionDropdown{{ req.id }}">
                                    <li>
                                        <form action="{{ url_for('csr.accept_request', request_id=req.id) }}" method="POST">
                                            <button type="submit" class="dropdown-item">Accept</button>
                                        </form>
                                    </li>
                                    <li>
                                        <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#assignModal{{ req.id }}">
                                            Assign Volunteer
                                        </button>
                                    </li>
                                    <li>
                                        <form action="{{ url_for('csr.complete_request', request_id=req.id) }}" method="POST">
                                            <button type="submit" class="dropdown-item">Complete Request</button>
                                        </form>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form action="{{ url_for('csr.delete_request', request_id=req.id) }}" method="POST">
                                            <button type="submit" class="dropdown-item text-danger"
                                                    onclick="return confirm('Are you sure you want to delete this request?');">
                                                Delete
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>

                            <!-- Assign Modal -->
                            <div class="modal fade" id="assignModal{{ req.id }}" tabindex="-1" aria-labelledby="assignModalLabel{{ req.id }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <form action="{{ url_for('csr.assign_request', request_id=req.id) }}" method="POST">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="assignModalLabel{{ req.id }}">Assign Request #{{ req.id }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <label for="volunteer_id" class="form-label">Select Volunteer:</label>
                                                <select name="volunteer_id" class="form-select" required>
                                                    <option value="" disabled selected>Select volunteer</option>
                                                    {% for v in users if v.role == 'volunteer' %}
                                                        <option value="{{ v.id }}">{{ v.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-primary">Assign</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div>
                                <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                                <h5 class="text-muted mt-3">No requests found</h5>
                                <p class="text-muted">All PIN requests will appear here.</p>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {% if requests_with_users %}
    <div class="mt-3 text-muted">
        Total Requests: <strong>{{ requests_with_users|length }}</strong>
    </div>
    {% endif %}
</div>

<script>
const searchInput = document.getElementById('searchInput');
const statusFilter = document.getElementById('statusFilter');
const tableBody = document.getElementById('requestTableBody');
const tableRows = tableBody.getElementsByTagName('tr');

function filterTable() {
    const searchValue = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;

    for (let i = 0; i < tableRows.length; i++) {
        const row = tableRows[i];

        // Skip rows with no data (like "No requests found")
        if (row.cells.length < 7) continue;

        const id = row.cells[0].textContent.toLowerCase();
        const title = row.cells[1].textContent.toLowerCase();
        const pin = row.cells[2].textContent.toLowerCase();
        const category = row.cells[3].textContent.toLowerCase();
        const status = row.cells[4].textContent.trim();

        const matchesSearch = searchValue === '' ||
                              id.includes(searchValue) ||
                              title.includes(searchValue) ||
                              pin.includes(searchValue) ||
                              category.includes(searchValue);

        const matchesStatus = statusValue === '' || status.includes(statusValue);

        row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
    }
}

searchInput.addEventListener('keyup', filterTable);
statusFilter.addEventListener('change', filterTable);
</script>
{% endblock %}
